name: Create Docker image

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
      
    - uses: actions/cache@v1
      with:
        path: ~/.npm
        key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-node-
    
    - name: Build the Docker image
      run: |
       npm ci --only=production
       npm run build
       docker login docker.pkg.github.com -u anpleenko -p ${{ secrets.TOKEN }}
       docker build . --file Dockerfile --tag bookmarks
       docker tag bookmarks docker.pkg.github.com/7qw/bookmarks/bookmarks:latest
       docker push docker.pkg.github.com/7qw/bookmarks/bookmarks:latest
  
    - name: SSH connect
      uses: garygrossgarten/github-action-ssh@release
      with:
        command: cd /usr/src/docker && ./up.sh
        host: ${{ secrets.HOST }}
        username: deploy
        privateKey: ${{ secrets.SSH_PRIVATE_KEY}}
    

